name: Deploy to EC2 (Airflow + dbt)

on:
  push:
    branches: ["main"]
  workflow_dispatch:

env:
  DEPLOY_PATH: /opt/Threelacha_airflow_dbt

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      # 1. ÏΩîÎìú Ï≤¥ÌÅ¨ÏïÑÏõÉ
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. Î∞∞Ìè¨ ÏãúÏûë Í∏∞Î°ù
      - name: Record deployment start
        run: |
          echo "================================================" | sudo tee -a /opt/deployment.log
          echo "üöÄ Deployment started at $(date '+%Y-%m-%d %H:%M:%S')" | sudo tee -a /opt/deployment.log
          echo "üìù Commit: ${{ github.sha }}" | sudo tee -a /opt/deployment.log
          echo "üë§ Triggered by: ${{ github.actor }}" | sudo tee -a /opt/deployment.log

      # 3. Î∞∞Ìè¨ Ï†Ñ Î∞±ÏóÖ (ÏµúÍ∑º 3Í∞ú Ïú†ÏßÄ)
      - name: Backup current deployment
        run: |
          if [ -d ${{ env.DEPLOY_PATH }} ]; then
            sudo cp -r ${{ env.DEPLOY_PATH }} \
              ${{ env.DEPLOY_PATH }}.backup.$(date +%Y%m%d_%H%M%S)

            cd /opt
            sudo ls -dt Threelacha_airflow_dbt.backup.* \
              | tail -n +4 \
              | xargs -r sudo rm -rf

            echo "‚úÖ Backup created" | sudo tee -a /opt/deployment.log
          fi

      # 4. ÏΩîÎìú ÎèôÍ∏∞Ìôî
      - name: Sync code to service directory
        run: |
          sudo mkdir -p ${{ env.DEPLOY_PATH }}
          sudo rsync -av --delete \
            --exclude='.git' \
            --exclude='.github' \
            --exclude='airflow/logs' \
            --exclude='__pycache__' \
            --exclude='*.pyc' \
            --exclude='.env' \
            ${{ github.workspace }}/ ${{ env.DEPLOY_PATH }}/
          sudo chown -R ubuntu:ubuntu ${{ env.DEPLOY_PATH }}
          echo "‚úÖ Code synced" | sudo tee -a /opt/deployment.log

      # 5. ÌôòÍ≤Ω Î≥ÄÏàò Î°úÎìú
      - name: Load environment variables
        run: |
          if [ -f /home/ubuntu/.env ]; then
            sudo cp /home/ubuntu/.env ${{ env.DEPLOY_PATH }}/.env
            sudo chown ubuntu:ubuntu ${{ env.DEPLOY_PATH }}/.env
            echo "‚úÖ .env loaded" | sudo tee -a /opt/deployment.log
          else
            echo "‚ùå /home/ubuntu/.env not found" | sudo tee -a /opt/deployment.log
            exit 1
          fi

      # 6. Docker Compose ÏÑ§Ï†ï Í≤ÄÏ¶ù
      - name: Validate Docker Compose configuration
        run: |
          cd ${{ env.DEPLOY_PATH }}
          docker compose config > /dev/null
          echo "‚úÖ Docker Compose config validated" | sudo tee -a /opt/deployment.log

      # 7. Ïù¥ÎØ∏ÏßÄ Í∞±Ïã† (ÏÑ†ÌÉù)
      - name: Pull latest images
        run: |
          cd ${{ env.DEPLOY_PATH }}
          docker compose pull || true
          echo "‚úÖ Images pulled" | sudo tee -a /opt/deployment.log

      # 8. ÏÑúÎπÑÏä§ Ïû¨Í∏∞Îèô
      - name: Restart services
        run: |
          cd ${{ env.DEPLOY_PATH }}
          docker compose up -d --build
          echo "‚úÖ Services restarted" | sudo tee -a /opt/deployment.log

      # 9. Ïª®ÌÖåÏù¥ÎÑà ÏÉÅÌÉú ÌôïÏù∏
      - name: Verify containers
        run: |
          echo "üì¶ Running containers:"
          docker ps
          echo ""
          cd ${{ env.DEPLOY_PATH }} && docker compose ps
          echo "‚úÖ Containers verified" | sudo tee -a /opt/deployment.log

      # 10. Airflow Ìó¨Ïä§ Ï≤¥ÌÅ¨ (5Î∂Ñ)
      - name: Health check Airflow (5 minutes)
        run: |
          for i in {1..30}; do
            if curl -sf http://localhost:8080/api/v2/monitor/health > /dev/null
              echo "‚úÖ Airflow is healthy" | sudo tee -a /opt/deployment.log
              exit 0
            fi
            echo "‚è≥ Waiting for Airflow... ($i/30)"
            sleep 10
          done

          echo "‚ùå Airflow health check failed after 5 minutes" | sudo tee -a /opt/deployment.log
          cd ${{ env.DEPLOY_PATH }} && docker compose logs --tail=50
          exit 1

      # 11. Î∞∞Ìè¨ ÏÑ±Í≥µ Í∏∞Î°ù
      - name: Record deployment success
        if: success()
        run: |
          echo "‚úÖ Deployment completed successfully at $(date '+%Y-%m-%d %H:%M:%S')" | sudo tee -a /opt/deployment.log
          echo "================================================" | sudo tee -a /opt/deployment.log
          echo "" | sudo tee -a /opt/deployment.log

      # 12. Ïã§Ìå® Ïãú Î°§Î∞±
      - name: Rollback on failure
        if: failure()
        run: |
          echo "‚ùå Deployment failed at $(date '+%Y-%m-%d %H:%M:%S')" | sudo tee -a /opt/deployment.log
          echo "üîÑ Rolling back..." | sudo tee -a /opt/deployment.log

          LATEST_BACKUP=$(ls -dt ${{ env.DEPLOY_PATH }}.backup.* 2>/dev/null | head -n 1)
          if [ -n "$LATEST_BACKUP" ]; then
            sudo rm -rf ${{ env.DEPLOY_PATH }}
            sudo cp -r "$LATEST_BACKUP" ${{ env.DEPLOY_PATH }}
            cd ${{ env.DEPLOY_PATH }}
            docker compose up -d
            echo "‚úÖ Rolled back to $LATEST_BACKUP" | sudo tee -a /opt/deployment.log
          else
            echo "‚ö†Ô∏è No backup available" | sudo tee -a /opt/deployment.log
          fi

          echo "================================================" | sudo tee -a /opt/deployment.log
          echo "" | sudo tee -a /opt/deployment.log

      # 13. Ìï≠ÏÉÅ ÏµúÍ∑º Î°úÍ∑∏ Ï∂úÎ†•
      - name: Show recent logs
        if: always()
        run: |
          echo "üìù Recent container logs:"
          cd ${{ env.DEPLOY_PATH }} && docker compose logs --tail=30