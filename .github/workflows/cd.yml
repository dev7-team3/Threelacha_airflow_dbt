name: Deploy to EC2 (Airflow + dbt)

on:
  push:
    branches: ["main"]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: self-hosted
    
    steps:
      # 1. ÏΩîÎìú Ï≤¥ÌÅ¨ÏïÑÏõÉ
      - name: Checkout repository
        uses: actions/checkout@v4
      
      # 2. Î∞∞Ìè¨ ÏãúÏûë ÏãúÍ∞Ñ Í∏∞Î°ù
      - name: Record deployment start
        run: |
          echo "================================================" | sudo tee -a /opt/deployment.log
          echo "üöÄ Deployment started at $(date '+%Y-%m-%d %H:%M:%S')" | sudo tee -a /opt/deployment.log
          echo "üìù Commit: ${{ github.sha }}" | sudo tee -a /opt/deployment.log
          echo "üë§ Triggered by: ${{ github.actor }}" | sudo tee -a /opt/deployment.log
      
      # 3. Î∞∞Ìè¨ Ï†Ñ Î∞±ÏóÖ (ÏµúÍ∑º 3Í∞ú Ïú†ÏßÄ)
      - name: Backup current deployment
        run: |
          if [ -d /opt/Threelacha_airflow_dbt ]; then
            sudo cp -r /opt/Threelacha_airflow_dbt \
              /opt/Threelacha_airflow_dbt.backup.$(date +%Y%m%d_%H%M%S)
            cd /opt
            sudo ls -dt Threelacha_airflow_dbt.backup.* \
              | tail -n +4 \
              | xargs -r sudo rm -rf
            echo "‚úÖ Backup created" | sudo tee -a /opt/deployment.log
          fi
      
      # 4. ÏΩîÎìú ÎèôÍ∏∞Ìôî
      - name: Sync code to service directory
        run: |
          sudo mkdir -p /opt/Threelacha_airflow_dbt
          sudo rsync -av --delete \
            --exclude='.git' \
            --exclude='.github' \
            --exclude='airflow/logs' \
            --exclude='__pycache__' \
            --exclude='*.pyc' \
            --exclude='.env' \
            ${{ github.workspace }}/ /opt/Threelacha_airflow_dbt/
          sudo chown -R ubuntu:ubuntu /opt/Threelacha_airflow_dbt
          echo "‚úÖ Code synced" | sudo tee -a /opt/deployment.log
      
      # 5. ÌôòÍ≤Ω Î≥ÄÏàò Î°úÎìú (.envÎäî Ìôà ÎîîÎ†âÌÜ†Î¶¨ Í∏∞Ï§Ä)
      - name: Load environment variables
        run: |
          if [ -f /home/ubuntu/.env ]; then
            sudo cp /home/ubuntu/.env /opt/Threelacha_airflow_dbt/.env
            sudo chown ubuntu:ubuntu /opt/Threelacha_airflow_dbt/.env
            echo "‚úÖ .env loaded" | sudo tee -a /opt/deployment.log
          else
            echo "‚ùå /home/ubuntu/.env not found" | sudo tee -a /opt/deployment.log
            exit 1
          fi
      
      # 6. Docker Compose ÏÑ§Ï†ï Í≤ÄÏ¶ù
      - name: Validate Docker Compose configuration
        working-directory: /opt/Threelacha_airflow_dbt
        run: |
          docker compose config > /dev/null
          echo "‚úÖ Docker Compose config validated" | sudo tee -a /opt/deployment.log
      
      # 7. Ïù¥ÎØ∏ÏßÄ Í∞±Ïã†
      - name: Pull latest images
        working-directory: /opt/Threelacha_airflow_dbt
        run: |
          docker compose pull || true
          echo "‚úÖ Images pulled" | sudo tee -a /opt/deployment.log
      
      # 8. ÏÑúÎπÑÏä§ Ïû¨Í∏∞Îèô (Îã§Ïö¥ÌÉÄÏûÑ ÏµúÏÜåÌôî)
      - name: Restart services
        working-directory: /opt/Threelacha_airflow_dbt
        run: |
          docker compose up -d --build
          echo "‚úÖ Services restarted" | sudo tee -a /opt/deployment.log
      
      # 9. Ïª®ÌÖåÏù¥ÎÑà ÏÉÅÌÉú ÌôïÏù∏
      - name: Verify containers
        run: |
          echo "üì¶ Running containers:"
          docker ps
          echo ""
          docker compose -f /opt/Threelacha_airflow_dbt/docker-compose.yml ps
          echo "‚úÖ Containers verified" | sudo tee -a /opt/deployment.log
      
      # 10. Airflow Ìó¨Ïä§ Ï≤¥ÌÅ¨ (3Î∂Ñ = 18Ìöå √ó 10Ï¥à)
      - name: Health check Airflow (3 minutes)
        run: |
          for i in {1..18}; do
            if curl -sf http://localhost:8080/health > /dev/null; then
              echo "‚úÖ Airflow is healthy" | sudo tee -a /opt/deployment.log
              exit 0
            fi
            echo "‚è≥ Waiting for Airflow... ($i/18)"
            sleep 10
          done
          echo "‚ùå Airflow health check failed after 3 minutes" | sudo tee -a /opt/deployment.log
          docker compose -f /opt/Threelacha_airflow_dbt/docker-compose.yml logs --tail=50
          exit 1
      
      # 11. Î∞∞Ìè¨ ÏÑ±Í≥µ Í∏∞Î°ù
      - name: Record deployment success
        if: success()
        run: |
          echo "‚úÖ Deployment completed successfully at $(date '+%Y-%m-%d %H:%M:%S')" | sudo tee -a /opt/deployment.log
          echo "================================================" | sudo tee -a /opt/deployment.log
          echo "" | sudo tee -a /opt/deployment.log
      
      # 12. Ïã§Ìå® Ïãú Î°§Î∞±
      - name: Rollback on failure
        if: failure()
        run: |
          echo "‚ùå Deployment failed at $(date '+%Y-%m-%d %H:%M:%S')" | sudo tee -a /opt/deployment.log
          echo "üîÑ Rolling back..." | sudo tee -a /opt/deployment.log
          LATEST_BACKUP=$(ls -dt /opt/Threelacha_airflow_dbt.backup.* 2>/dev/null | head -n 1)
          if [ -n "$LATEST_BACKUP" ]; then
            sudo rm -rf /opt/Threelacha_airflow_dbt
            sudo cp -r "$LATEST_BACKUP" /opt/Threelacha_airflow_dbt
            cd /opt/Threelacha_airflow_dbt
            docker compose up -d
            echo "‚úÖ Rolled back to $LATEST_BACKUP" | sudo tee -a /opt/deployment.log
          else
            echo "‚ö†Ô∏è No backup available" | sudo tee -a /opt/deployment.log
          fi
          echo "================================================" | sudo tee -a /opt/deployment.log
          echo "" | sudo tee -a /opt/deployment.log
      
      # 13. Ìï≠ÏÉÅ ÏµúÍ∑º Î°úÍ∑∏ Ï∂úÎ†•
      - name: Show recent logs
        if: always()
        run: |
          echo "üìù Recent container logs:"
          docker compose -f /opt/Threelacha_airflow_dbt/docker-compose.yml logs --tail=30