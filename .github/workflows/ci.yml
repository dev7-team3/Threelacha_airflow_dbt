name: CI (Airflow + dbt)

on:
  pull_request:
    branches: ["main", "dev"]
  push:
    branches: ["dev"]

jobs:
  ci:
    runs-on: ubuntu-latest

    env:
      # -------------------------------------------------
      # Airflow (CI ìµœì†Œ êµ¬ì„±)
      # -------------------------------------------------
      AIRFLOW_HOME: /tmp/airflow
      AIRFLOW__CORE__EXECUTOR: SequentialExecutor
      AIRFLOW__CORE__LOAD_EXAMPLES: "False"
      AIRFLOW__DATABASE__SQL_ALCHEMY_CONN: sqlite:////tmp/airflow/airflow.db

      # DAG / Plugin ê²½ë¡œ ëª…ì‹œ (ðŸ”¥ í•µì‹¬)
      AIRFLOW__CORE__DAGS_FOLDER: ${{ github.workspace }}/airflow/dags
      AIRFLOW__CORE__PLUGINS_FOLDER: ${{ github.workspace }}/airflow/plugins

    steps:
      # -------------------------------------------------
      # 1. Checkout
      # -------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # -------------------------------------------------
      # 2. uv ì„¤ì¹˜
      # -------------------------------------------------
      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          enable-cache: true
          cache-dependency-glob: "uv.lock"

      # -------------------------------------------------
      # 3. Python ì„¤ì¹˜
      # -------------------------------------------------
      - name: Install Python
        run: uv python install 3.11

      # -------------------------------------------------
      # 4. ì˜ì¡´ì„± ë™ê¸°í™” (lock ê³ ì •)
      # -------------------------------------------------
      - name: Sync dependencies
        run: uv sync --frozen

      # -------------------------------------------------
      # 5. Ruff lint
      # -------------------------------------------------
      - name: Ruff lint
        run: |
          echo "ðŸ” Running ruff lint..."
          uv run ruff check .

      # -------------------------------------------------
      # 6. Ruff format check (soft)
      # -------------------------------------------------
      - name: Ruff format check
        run: |
          echo "ðŸŽ¨ Checking code formatting..."
          uv run ruff format --check .
        continue-on-error: true

      # -------------------------------------------------
      # 7. Airflow DB ì´ˆê¸°í™”
      # -------------------------------------------------
      - name: Init Airflow DB
        run: |
          echo "ðŸ—„ï¸ Initializing Airflow database..."
          mkdir -p "$AIRFLOW_HOME"
          uv run airflow db migrate

      # -------------------------------------------------
      # 8. Airflow DAG validation
      # -------------------------------------------------
      - name: Airflow DAG validation
        run: |
          echo "ðŸ“‹ Validating Airflow DAGs..."

          # DAG ì§ë ¬í™”
          uv run airflow dags reserialize

          # Import ì—ëŸ¬ ì²´í¬
          echo "Checking for import errors..."
          ERRORS=$(uv run airflow dags list-import-errors || true)

          if echo "$ERRORS" | grep -q "BROKEN DAG"; then
            echo "âŒ Found DAG import errors:"
            echo "$ERRORS"
            exit 1
          fi

          echo "âœ… All DAGs validated successfully"
          echo ""
          echo "Available DAGs:"
          uv run airflow dags list

      # -------------------------------------------------
      # 9. dbt deps (optional)
      # -------------------------------------------------
      - name: dbt deps
        run: |
          if [ -f dbt/Threelacha/packages.yml ]; then
            echo "ðŸ“¦ Installing dbt packages..."
            uv run dbt deps \
              --project-dir dbt/Threelacha \
              --profiles-dir dbt/Threelacha
          else
            echo "â­ï¸ No packages.yml found, skipping dbt deps"
          fi

      # -------------------------------------------------
      # 10. dbt compile (DuckDB, CI safe)
      # -------------------------------------------------
      - name: dbt compile
        run: |
          echo "ðŸ”¨ Compiling dbt models..."
          uv run dbt compile \
            --project-dir dbt/Threelacha \
            --profiles-dir dbt/Threelacha
          echo "âœ… dbt compile succeeded"

      # -------------------------------------------------
      # 11. dbt parse (soft check)
      # -------------------------------------------------
      - name: dbt parse
        run: |
          echo "ðŸ“ Parsing dbt project..."
          uv run dbt parse \
            --project-dir dbt/Threelacha \
            --profiles-dir dbt/Threelacha
        continue-on-error: true

      # -------------------------------------------------
      # 12. CI Summary
      # -------------------------------------------------
      - name: CI Summary
        if: always()
        run: |
          echo "## ðŸŽ¯ CI Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ job.status }}" == "success" ]; then
            echo "### âœ… All checks passed!" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âŒ Some checks failed" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Completed checks:**" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ” Ruff lint" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸŒŠ Airflow DAG validation" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ¦† dbt compile (DuckDB)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:**" >> $GITHUB_STEP_SUMMARY
          echo "- Python: 3.11 (via uv)" >> $GITHUB_STEP_SUMMARY
          echo "- Branch: \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Commit: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
